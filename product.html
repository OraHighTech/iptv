<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DÃ©tails du Produit - IPTV Store</title>

    <meta
      name="description"
      content="DÃ©couvrez nos abonnements IPTV premium. Service de haute qualitÃ©, stable et riche en contenu."
    />

    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://raw.githack.com/OraHighTech/OrderTvCode/main/indicatif.js"></script>

    <script type="application/ld+json" id="product-schema"></script>
    
    <style>
      .loading-form {
        text-align: center;
        padding: 40px;
        color: var(--secondary-color);
      }
      
      .virtual-form, .delivery-form {
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
      }
      
      .virtual-form {
        border: 2px solid var(--primary-color);
        background: rgba(90, 71, 251, 0.05);
      }

      .delivery-form {
        border: 2px solid #28a745;
        background: rgba(40, 167, 69, 0.05);
      }

      /* Correction pour l'affichage des images */
      .main-image-container-fade img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: absolute;
        top: 0;
        left: 0;
      }

      .main-image-container-fade img:not(:first-child) {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="header-placeholder"></div>

    <main class="product-page-container-new">
      <section class="product-gallery-section">
        <div class="image-gallery-horizontal">
          <div class="main-image-container-fade">
            <!-- Les images seront ajoutÃ©es ici par JavaScript -->
          </div>
          <div id="thumbnail-container" class="thumbnail-container-horizontal"></div>
        </div>
      </section>

      <section class="product-intro">
        <h1 id="product-name" class="product-title-main">Chargement...</h1>
        <p id="product-excerpt" class="product-excerpt-main"></p>
      </section>

      <!-- Section du formulaire dynamique -->
      <div id="form-container">
        <div class="loading-form">
          <i class="fas fa-spinner fa-spin"></i> Chargement du formulaire...
        </div>
      </div>

      <section class="product-full-description">
        <h2 class="section-title-small">Description DÃ©taillÃ©e</h2>
        <p id="product-description" class="product-description-main"></p>
      </section>

      <section class="payment-methods">
        <h2 class="section-title-small">Moyens de paiement acceptÃ©s</h2>
        <div class="payment-icons">
          <img src="https://www.iptv-store.shop/logo/binance-logo.png" alt="Binance Pay" />
          <img src="https://www.iptv-store.shop/logo/iban-logo.png" alt="Virement bancaire IBAN" />
          <img src="https://www.iptv-store.shop/logo/paypal-logo.png" alt="PayPal" />
        </div>
      </section>

      <div class="share-buttons-container">
        <a id="share-facebook" class="share-btn facebook" href="#" target="_blank" aria-label="Partager sur Facebook"
          ><i class="fab fa-facebook-f"></i
        ></a>
        <a id="share-twitter" class="share-btn twitter" href="#" target="_blank" aria-label="Partager sur Twitter"
          ><i class="fab fa-twitter"></i
        ></a>
        <a id="share-whatsapp" class="share-btn whatsapp" href="#" target="_blank" aria-label="Partager sur WhatsApp"
          ><i class="fab fa-whatsapp"></i
        ></a>
        <a id="share-telegram" class="share-btn telegram" href="#" target="_blank" aria-label="Partager sur Telegram"
          ><i class="fab fa-telegram-plane"></i
        ></a>
        <button id="copy-link" class="share-btn copy-link" aria-label="Copier le lien">
          <i class="fas fa-copy"></i>
        </button>
      </div>
    </main>
    
    <div id="waitingMessage" class="waiting-message" style="display: none">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
    <div id="customAlert" class="custom-alert" style="display: none">
      <div class="alert-content">
        <span class="close-btn" onclick="closeAlert()">&times;</span>
        <p id="alertMessage"></p>
        <button class="ok-btn" onclick="closeAlert()">OK</button>
      </div>
    </div>
    <div id="lightbox" class="lightbox-overlay">
      <span class="lightbox-close">&times;</span><img id="lightbox-image" class="lightbox-image" src="" />
    </div>

    <div id="footer-placeholder"></div>
    
    <script src="products-db.js"></script>
    <script>
      // ===== CODE PRINCIPAL =====
      let currentProduct = null;
      let useDZD = false;

      // Fonction pour rÃ©cupÃ©rer l'ID du produit
      function getProductIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
      }

      // DÃ©tection du pays
      async function detectUserCountry() {
        try {
          const response = await fetch('https://api.ipdata.co/?api-key=916c6b6e4d160441313fb81c071aa9aadd988baa6e8e4361cfa6ad38');
          const data = await response.json();
          useDZD = (data.country_code === 'DZ');
          console.log('Pays dÃ©tectÃ©:', data.country_code, 'useDZD:', useDZD);
          return useDZD;
        } catch (error) {
          console.error('Erreur dÃ©tection pays:', error);
          useDZD = false;
          return false;
        }
      }

      // Initialiser les codes pays
      function populateCountryCodes(selectId) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement || typeof countryCodes === 'undefined') return;
        
        selectElement.innerHTML = '';
        countryCodes.forEach(country => {
          const option = document.createElement("option");
          option.value = country.code;
          option.textContent = `${country.name} (${country.code})`;
          selectElement.appendChild(option);
        });
        selectElement.value = "+213";
      }

      // CORRECTION : Formulaire physique COMPLET avec livraison
      function createPhysicalForm(product) {
        const price = useDZD ? (product.price_dzd || product.price * 160) : product.price;
        const currency = useDZD ? ' DZD' : ' â‚¬';
        const priceFormatted = useDZD ? price.toFixed(0) : price.toFixed(2);
        
        return `
          <div class="delivery-form">
            <h3 style="text-align: center; margin-bottom: 20px; color: #28a745;">ğŸ“¦ Commande avec Livraison</h3>
            
            <div class="form-all" style="direction: rtl;">
              <div class="form-ligne">
                <label class="form-ligne">
                  <div class="form-ligne-fa"><i class="fa fa-user"></i></div>
                  <input id="delivery-name" placeholder="Ø§Ù„Ø¥Ø³Ù… Ùˆ Ø§Ù„Ù„Ù‚Ø¨" required type="text" />
                </label>
                <div class="error-message-f" id="deliveryNameError"></div>
              </div>

              <div class="form-ligne">
                <label class="form-ligne">
                  <div class="form-ligne-fa"><i class="fa fa-phone"></i></div>
                  <input id="delivery-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required type="tel" />
                </label>
                <div class="error-message-f" id="deliveryPhoneError"></div>
              </div>

              <div class="form-ligne">
                <label class="form-ligne">
                  <div class="form-ligne-fa"><i class="fa fa-map-marker-alt"></i></div>
                  <input id="delivery-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„" required type="text" />
                </label>
                <div class="error-message-f" id="deliveryAddressError"></div>
              </div>

              <!-- Order Summary -->
              <div class="Order-Summary">
                <div class="Order-Summary-t"><i class="fa fa-shopping-basket"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</div>
                <div class="order-prod">
                  <div class="order-prod-t-p-q">
                    <p style="font-weight: bold;">${product.name}</p>
                    <div class="OderPrice">
                      <p id="physical-quantity">1</p>
                      <p>x</p>
                      <p>${priceFormatted}${currency}</p>
                    </div>
                  </div>
                  <div class="order-prod-d">
                    <p>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ :</p>
                    <p>500 Ø¯Ø¬</p>
                  </div>
                  <div class="order-prod-P-t">
                    <p>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ :</p>
                    <p class="total-price0">${useDZD ? (price + 500).toFixed(0) : (price + 3).toFixed(2)} ${useDZD ? 'Ø¯Ø¬' : 'â‚¬'}</p>
                  </div>
                </div>
              </div>

              <div class="b-order">
                <div class="quantity">
                  <span class="button-Q" onclick="decreasePhysicalQuantity()">-</span>
                  <input class="quantity" id="physical-quantity-input" type="text" value="1" readonly />
                  <span class="button-Q" onclick="increasePhysicalQuantity()">+</span>
                </div>
                <button class="buy-button-w" onclick="sendPhysicalOrder()">
                  <i class="fa fa-brands fa-whatsapp"></i>
                </button>
                <button class="buy-button-emailjs" onclick="sendPhysicalOrder()">
                  ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ <i class="fa fa-shopping-cart"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }

      // Fonctions pour la quantitÃ© des produits physiques
      function increasePhysicalQuantity() {
        const quantityInput = document.getElementById('physical-quantity-input');
        const quantityDisplay = document.getElementById('physical-quantity');
        let quantity = parseInt(quantityInput.value) || 1;
        quantityInput.value = quantity + 1;
        quantityDisplay.textContent = quantity + 1;
        updatePhysicalTotalPrice();
      }

      function decreasePhysicalQuantity() {
        const quantityInput = document.getElementById('physical-quantity-input');
        const quantityDisplay = document.getElementById('physical-quantity');
        let quantity = parseInt(quantityInput.value) || 1;
        if (quantity > 1) {
          quantityInput.value = quantity - 1;
          quantityDisplay.textContent = quantity - 1;
          updatePhysicalTotalPrice();
        }
      }

      function updatePhysicalTotalPrice() {
        if (!currentProduct) return;
        
        const quantity = parseInt(document.getElementById('physical-quantity-input').value) || 1;
        const price = useDZD ? (currentProduct.price_dzd || currentProduct.price * 160) : currentProduct.price;
        const deliveryFee = useDZD ? 500 : 3; // Frais de livraison
        const totalPrice = (price * quantity) + deliveryFee;
        const currency = useDZD ? ' Ø¯Ø¬' : ' â‚¬';
        const decimals = useDZD ? 0 : 2;
        
        document.querySelector('.total-price0').textContent = totalPrice.toFixed(decimals) + currency;
      }

      // Envoyer commande physique
      function sendPhysicalOrder() {
        const name = document.getElementById('delivery-name').value.trim();
        const phone = document.getElementById('delivery-phone').value.trim();
        const address = document.getElementById('delivery-address').value.trim();
        const quantity = document.getElementById('physical-quantity-input').value;

        // Validation
        if (!name) {
          document.getElementById('deliveryNameError').textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…';
          return;
        }
        if (!phone) {
          document.getElementById('deliveryPhoneError').textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ';
          return;
        }
        if (!address) {
          document.getElementById('deliveryAddressError').textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†';
          return;
        }

        const price = useDZD ? (currentProduct.price_dzd || currentProduct.price * 160) : currentProduct.price;
        const deliveryFee = useDZD ? 500 : 3;
        const totalPrice = (price * quantity) + deliveryFee;
        const currency = useDZD ? 'DZD' : 'EUR';

        const message = `ğŸ¯ **Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø´Ø­Ù†** ğŸ¯

ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬: ${currentProduct.name}
ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${name}
ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${phone}
ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${address}
ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}
ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬: ${useDZD ? price.toFixed(0) : price.toFixed(2)} ${currency}
ğŸšš Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªÙˆØµÙŠÙ„: ${deliveryFee} ${useDZD ? 'Ø¯Ø¬' : 'â‚¬'}
ğŸ’µ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${useDZD ? totalPrice.toFixed(0) : totalPrice.toFixed(2)} ${currency}

Ø´ÙƒØ±Ø§ Ù„Ø«Ù‚ØªÙƒÙ…! ğŸš€`;

        const whatsappUrl = `https://api.whatsapp.com/send?phone=213770759886&text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
      }

      // Fonction pour crÃ©er le formulaire virtuel
      function createVirtualForm(product) {
        const price = useDZD ? (product.price_dzd || product.price * 160) : product.price;
        const currency = useDZD ? ' DZD' : ' â‚¬';
        const priceFormatted = useDZD ? price.toFixed(0) : price.toFixed(2);
        
        return `
          <section class="product-form-section virtual-form">
            <form id="orderForm" class="order-form-card">
              <h3 class="form-title">Passez votre commande</h3>
              <p class="product-price-main" id="popupPrice">${priceFormatted}${currency}</p>

              <div class="form-group">
                <i class="fas fa-server icon"></i>
                <select id="serverType" onchange="toggleServerFields(); updateTotalPrice();">
                  ${(product.serverTypes || []).map(type => 
                    `<option value="${type}">${type}</option>`
                  ).join('')}
                </select>
              </div>
              <div id="serverFields" class="server-fields"></div>
              
              <div class="form-group">
                <i class="fas fa-cubes icon"></i>
                <input type="number" id="quantity" value="1" min="1" onchange="updateTotalPrice()" placeholder="QuantitÃ©" />
              </div>
              
              <div class="form-group">
                <i class="fas fa-user icon"></i>
                <input type="text" id="name" placeholder="Votre Nom *" />
              </div>
              <p class="error-message" id="nameError"></p>

              <div class="form-group">
                <div class="whatsapp-input-group">
                  <select id="selectedCountryCode" class="country-code-select-standalone"></select>
                  <input type="tel" id="phone" placeholder="NumÃ©ro WhatsApp" />
                </div>
              </div>
              <p class="error-message" id="phoneError"></p>

              <div class="form-group">
                <i class="fas fa-envelope icon"></i>
                <input type="email" id="email" placeholder="Adresse Email (Optionnel)" />
              </div>
              <p class="error-message" id="emailError"></p>

              <div class="button-group">
                <button type="button" class="btn btn-whatsapp" onclick="sendVirtualOrder('whatsapp')">
                  <i class="fab fa-whatsapp"></i> Commander via WhatsApp
                </button>
                <button type="button" class="btn btn-email" onclick="sendVirtualOrder('email')">
                  <i class="fas fa-envelope"></i> Commander par Email
                </button>
              </div>
            </form>
          </section>
        `;
      }

      // Fonction pour envoyer la commande virtuelle
      function sendVirtualOrder(method) {
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();

        // Commande rapide WhatsApp sans formulaire
        if (method === 'whatsapp' && !name && !phone) {
          const productUrl = window.location.href;
          const price = useDZD ? (currentProduct.price_dzd || currentProduct.price * 160) : currentProduct.price;
          const currency = useDZD ? 'DZD' : 'EUR';
          const priceFormatted = useDZD ? price.toFixed(0) : price.toFixed(2);
          
          const simpleMessage = `Bonjour, je souhaite commander ce produit :\n\n` +
                                `*Produit :* ${currentProduct.name}\n` +
                                `*Prix :* ${priceFormatted} ${currency}\n` +
                                `*Lien :* ${productUrl}`;
          
          const whatsappUrl = `https://api.whatsapp.com/send?phone=213770759886&text=${encodeURIComponent(simpleMessage)}`;
          window.open(whatsappUrl, '_blank');
          displayAlert('Redirection vers WhatsApp...');
          return; 
        }

        // Validation du formulaire
        clearErrors();
        let valid = true;
        const email = document.getElementById("email").value.trim();
        const phoneRegex = /^\d{7,15}$/;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!name) {
          valid = false;
          document.getElementById("nameError").innerText = "Veuillez entrer votre nom.";
        }

        if (method === 'email' && !phone) {
          valid = false;
          document.getElementById("phoneError").innerText = "Veuillez entrer un numÃ©ro de tÃ©lÃ©phone.";
        } else if (phone && !phoneRegex.test(phone.replace(/[\s-()]/g, ''))) {
          valid = false;
          document.getElementById("phoneError").innerText = "Le format du numÃ©ro est invalide.";
        }

        if (email && !emailRegex.test(email)) {
          valid = false;
          document.getElementById("emailError").innerText = "Veuillez entrer une adresse email valide.";
        }
        
        if (!valid) {
          const firstError = document.querySelector('.error-message:not(:empty)');
          if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return;
        }

        // PrÃ©paration du message
        displayWaitingMessage();
        const quantity = parseInt(document.getElementById("quantity").value);
        const price = useDZD ? (currentProduct.price_dzd || currentProduct.price * 160) : currentProduct.price;
        const totalPrice = price * quantity;
        const orderNumber = generateOrderNumber();
        const fullPhoneNumber = phone ? `${document.getElementById("selectedCountryCode").value}${phone}` : 'N/A';
        const serverType = document.getElementById("serverType").value;
        const finalEmail = email || 'N/A';
        const currency = useDZD ? 'DZD' : 'EUR';
        
        const detailedMessage = `*Nouvelle commande!*\n*NumÃ©ro: ${orderNumber}\n*Produit: ${currentProduct.name}\n*Serveur: ${serverType}\n*Nom: ${name}\n*WhatsApp: ${fullPhoneNumber}\n*Email: ${finalEmail}\n*Prix unitaire: ${price.toFixed(useDZD ? 0 : 2)} ${currency}\n*QuantitÃ©: ${quantity}\n*Total: ${totalPrice.toFixed(useDZD ? 0 : 2)} ${currency}`;

        if (method === 'whatsapp') {
          window.open(`https://api.whatsapp.com/send?phone=213770759886&text=${encodeURIComponent(detailedMessage)}`, '_blank');
          hideWaitingMessage();
          displayAlert(`Redirection vers WhatsApp...`);
          document.getElementById('orderForm').reset();
        } else if (method === 'email') {
          const templateParams = { 
            orderNumber, 
            product: currentProduct.name, 
            serverType: serverType, 
            name: name, 
            phone: fullPhoneNumber, 
            email: finalEmail, 
            productPrice: price.toFixed(useDZD ? 0 : 2), 
            quantity: quantity, 
            totalPrice: totalPrice.toFixed(useDZD ? 0 : 2), 
            productDescription: currentProduct.description,
            currency: currency
          };
          emailjs.send("service_geh79gu", "template_vny80g3", templateParams)
            .then(() => {
              hideWaitingMessage();
              displayAlert(`Commande envoyÃ©e!<br>NumÃ©ro: ${orderNumber}`);
              document.getElementById('orderForm').reset();
            }, () => {
              hideWaitingMessage();
              displayAlert("Ã‰chec de l'envoi. Veuillez rÃ©essayer.");
            });
        }
      }

      // CORRECTION : Setup de la galerie - version simple qui fonctionne
      function setupCombinedGallery(product) {
        const mainImageContainer = document.querySelector('.main-image-container-fade');
        const thumbnailContainer = document.getElementById('thumbnail-container');
        
        if (!mainImageContainer || !thumbnailContainer || !product.images || product.images.length === 0) {
          console.error('Galerie: Ã©lÃ©ments manquants ou pas d\'images');
          return;
        }

        // Vider les conteneurs
        mainImageContainer.innerHTML = '';
        thumbnailContainer.innerHTML = '';

        console.log('Chargement des images:', product.images);

        // Ajouter la premiÃ¨re image comme image principale
        if (product.images[0]) {
          const mainImg = document.createElement('img');
          mainImg.src = product.images[0];
          mainImg.alt = `Image de ${product.name}`;
          mainImg.style.width = '100%';
          mainImg.style.height = '100%';
          mainImg.style.objectFit = 'contain';
          mainImg.style.display = 'block';
          mainImageContainer.appendChild(mainImg);
          console.log('Image principale chargÃ©e:', product.images[0]);
        }

        // Ajouter les miniatures
        product.images.forEach((imageUrl, index) => {
          const thumb = document.createElement('img');
          thumb.src = imageUrl;
          thumb.alt = `Miniature de ${product.name}`;
          thumb.style.cursor = 'pointer';
          thumb.style.width = '80px';
          thumb.style.height = '80px';
          thumb.style.objectFit = 'cover';
          thumb.style.border = index === 0 ? '2px solid var(--primary-color)' : '2px solid transparent';
          thumb.style.borderRadius = '8px';
          thumb.style.margin = '5px';
          
          thumb.addEventListener('click', () => {
            // Mettre Ã  jour l'image principale
            const mainImg = mainImageContainer.querySelector('img');
            if (mainImg) {
              mainImg.src = imageUrl;
            }
            
            // Mettre Ã  jour les bordures des miniatures
            thumbnailContainer.querySelectorAll('img').forEach((thumbImg, thumbIndex) => {
              thumbImg.style.border = thumbIndex === index ? '2px solid var(--primary-color)' : '2px solid transparent';
            });
          });
          
          thumbnailContainer.appendChild(thumb);
        });

        console.log('Galerie initialisÃ©e avec', product.images.length, 'images');
      }

      // Setup lightbox
      function setupLightbox(product) {
        const mainImageContainer = document.querySelector('.main-image-container-fade');
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxClose = document.querySelector('.lightbox-close');
        
        if (!mainImageContainer || !lightbox || !lightboxImage || !lightboxClose) return;

        mainImageContainer.style.cursor = 'zoom-in';
        mainImageContainer.addEventListener('click', (e) => {
          if (e.target.tagName === 'IMG') {
            const mainImg = mainImageContainer.querySelector('img');
            if (mainImg) {
              lightboxImage.src = mainImg.src;
              lightbox.style.display = 'flex';
            }
          }
        });
        
        lightboxClose.addEventListener('click', () => { 
          lightbox.style.display = 'none';
        });
        
        lightbox.addEventListener('click', (e) => { 
          if (e.target === lightbox) lightbox.style.display = 'none'; 
        });
      }

      // Setup des boutons de partage
      function setupShareButtons(product) {
        const shareUrl = window.location.href;
        const shareText = `DÃ©couvrez ${product.name} sur IPTV Store !`;

        const facebookBtn = document.getElementById('share-facebook');
        if(facebookBtn) { 
          facebookBtn.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`; 
        }
        
        const twitterBtn = document.getElementById('share-twitter');
        if(twitterBtn) { 
          twitterBtn.href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`; 
        }
        
        const whatsappBtn = document.getElementById('share-whatsapp');
        if(whatsappBtn) { 
          whatsappBtn.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText + ' ' + shareUrl)}`; 
        }
        
        const telegramBtn = document.getElementById('share-telegram');
        if(telegramBtn) { 
          telegramBtn.href = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareText)}`; 
        }
        
        const copyBtn = document.getElementById('copy-link');
        if(copyBtn) {
          copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(shareUrl).then(() => {
              copyBtn.innerHTML = '<i class="fas fa-check"></i>';
              setTimeout(() => { copyBtn.innerHTML = '<i class="fas fa-copy"></i>'; }, 2000);
            }).catch(err => { console.error('Erreur de copie: ', err); });
          });
        }
      }

      // Fonctions utilitaires
      function clearErrors() {
        document.querySelectorAll(".error-message").forEach(el => el.innerText = '');
      }

      function displayWaitingMessage() {
        const el = document.getElementById('waitingMessage');
        if(el) el.style.display = 'flex';
      }

      function hideWaitingMessage() {
        const el = document.getElementById('waitingMessage');
        if(el) el.style.display = 'none';
      }

      function displayAlert(message) {
        const alertMessage = document.getElementById('alertMessage');
        const customAlert = document.getElementById('customAlert');
        if (alertMessage) alertMessage.innerHTML = message;
        if (customAlert) customAlert.style.display = 'flex';
      }

      function closeAlert() {
        const customAlert = document.getElementById('customAlert');
        if (customAlert) customAlert.style.display = 'none';
      }

      function generateOrderNumber() {
        return `ORD-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
      }

      function updateTotalPrice() {
        const quantity = parseInt(document.getElementById("quantity")?.value || 1);
        const priceDisplay = document.getElementById('popupPrice');
        if (!priceDisplay || !currentProduct) return;
        
        const price = useDZD ? (currentProduct.price_dzd || currentProduct.price * 160) : currentProduct.price;
        let total = price * (quantity || 1);
        
        if (quantity > 20) total *= 0.9;
        else if (quantity > 10) total *= 0.95;
        
        const currency = useDZD ? ' DZD' : ' â‚¬';
        const decimals = useDZD ? 0 : 2;
        priceDisplay.innerText = total.toFixed(decimals) + currency;
      }

      function toggleServerFields() {
        const serverType = document.getElementById("serverType")?.value;
        const serverFields = document.getElementById('serverFields');
        if (!serverFields) return;

        serverFields.innerHTML = '';

        if (serverType === "mag") {
          serverFields.innerHTML = `
            <div class="form-group">
              <i class="fas fa-envelope icon"></i>
              <input type="text" id="macAddress" placeholder="Adresse MAC (ex: 00:1A:2B:3C:4D:5E)" maxlength="17" />
            </div>
          `;
          
          const macAddressInput = document.getElementById('macAddress');
          if (macAddressInput) {
            macAddressInput.addEventListener('input', (e) => {
              let value = e.target.value.replace(/[^0-9a-fA-F]/g, '');
              if (e.target.value.length > 0) {
                let formattedValue = (value.match(/.{1,2}/g) || []).join(':');
                e.target.value = formattedValue;
              }
            });
          }
        }
      }

      // Fonction principale d'initialisation
      async function initializeProductPage() {
        const productId = getProductIdFromURL();
        
        // VÃ©rifier si products est chargÃ©
        if (typeof products === 'undefined') {
          document.getElementById('form-container').innerHTML = '<div class="error-message">Erreur: Produits non chargÃ©s</div>';
          return;
        }
        
        currentProduct = products.find(p => p.id === productId);
        
        if (!currentProduct) {
          window.location.href = '404.html';
          return;
        }

        console.log('Produit trouvÃ©:', currentProduct);

        // DÃ©tecter le pays
        await detectUserCountry();

        // Mettre Ã  jour les informations du produit
        document.getElementById('product-name').textContent = currentProduct.name;
        
        // Description
        const fullDescription = currentProduct.description || '';
        document.getElementById('product-description').textContent = fullDescription;
        
        // Extrait
        const excerptElement = document.getElementById('product-excerpt');
        if (excerptElement) {
          let firstLine = fullDescription.split('\n')[0];
          let excerpt = firstLine.substring(0, 120);
          if (fullDescription.length > excerpt.length) {
            excerpt += '...';
          }
          excerptElement.textContent = excerpt;
        }

        // CORRECTION : Initialiser la galerie IMMÃ‰DIATEMENT
        setupCombinedGallery(currentProduct);

        // Initialiser le lightbox
        setupLightbox(currentProduct);

        // Initialiser les boutons de partage
        setupShareButtons(currentProduct);

        // CORRECTION : Charger le bon formulaire IMMÃ‰DIATEMENT
        const formContainer = document.getElementById('form-container');
        
        if (currentProduct.product_type === 'physical') {
          formContainer.innerHTML = createPhysicalForm(currentProduct);
          console.log('Formulaire PHYSIQUE chargÃ©');
        } else {
          formContainer.innerHTML = createVirtualForm(currentProduct);
          // Initialiser les codes pays
          populateCountryCodes('selectedCountryCode');
          // Initialiser les champs serveur
          setTimeout(() => toggleServerFields(), 100);
          console.log('Formulaire VIRTUEL chargÃ©');
        }

        // Mettre Ã  jour le schema SEO
        updateProductSchema(currentProduct);
      }

      // Mettre Ã  jour le schema SEO
      function updateProductSchema(product) {
        const price = useDZD ? (product.price_dzd || product.price * 160) : product.price;
        const currency = useDZD ? "DZD" : "EUR";
        
        const schema = {
          "@context": "https://schema.org/",
          "@type": "Product",
          "name": product.name,
          "image": product.images[0],
          "description": product.description,
          "sku": product.id,
          "brand": {
            "@type": "Brand",
            "name": "IPTV Store"
          },
          "offers": {
            "@type": "Offer",
            "url": window.location.href,
            "priceCurrency": currency,
            "price": useDZD ? (product.price_dzd || product.price * 160).toFixed(0) : product.price.toFixed(2),
            "availability": "https://schema.org/InStock",
            "itemCondition": "https://schema.org/NewCondition"
          }
        };
        
        const schemaScript = document.getElementById('product-schema');
        if (schemaScript) {
          schemaScript.textContent = JSON.stringify(schema);
        }
      }

      // Exposer les fonctions globalement
      window.sendVirtualOrder = sendVirtualOrder;
      window.sendPhysicalOrder = sendPhysicalOrder;
      window.increasePhysicalQuantity = increasePhysicalQuantity;
      window.decreasePhysicalQuantity = decreasePhysicalQuantity;
      window.updateTotalPrice = updateTotalPrice;
      window.toggleServerFields = toggleServerFields;
      window.closeAlert = closeAlert;

      // Charger les composants
      function loadComponent(url, elementId) {
        fetch(url)
          .then(response => response.text())
          .then(data => {
            const element = document.getElementById(elementId);
            if(element) element.innerHTML = data;
          })
          .catch(error => console.error(`Error loading component ${url}:`, error));
      }

      // Initialisation au chargement
      document.addEventListener('DOMContentLoaded', function() {
        // Initialiser EmailJS
        emailjs.init("WNOIpj1FX2dDPSQMS");
        
        // Charger header et footer
        loadComponent('header.html', 'header-placeholder');
        loadComponent('footer.html', 'footer-placeholder');
        
        // Initialiser la page produit
        initializeProductPage();
      });
    </script>
  </body>
</html>
