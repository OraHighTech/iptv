<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Détails du Produit - IPTV Store</title>

    <meta
      name="description"
      content="Découvrez nos abonnements IPTV premium. Service de haute qualité, stable et riche en contenu."
    />

    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://raw.githack.com/OraHighTech/OrderTvCode/main/indicatif.js"></script>

    <script type="application/ld+json" id="product-schema"></script>
    
    <style>
      /* Styles pour les formulaires */
      .virtual-form {
        border: 2px solid var(--primary-color);
        background: rgba(90, 71, 251, 0.05);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .delivery-form {
        border: 2px solid #28a745;
        background: rgba(40, 167, 69, 0.05);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .delivery-not-available {
        text-align: center;
        padding: 40px;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        margin: 20px 0;
        color: #856404;
      }

      .product-type-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 600;
        margin-left: 10px;
        vertical-align: middle;
      }

      .badge-virtual {
        background: var(--primary-color);
        color: white;
      }

      .badge-physical {
        background: #28a745;
        color: white;
      }
    </style>
  </head>
  <body>
    <div id="header-placeholder"></div>

    <main class="product-page-container-new">
      <section class="product-gallery-section">
        <div class="image-gallery-horizontal">
          <div class="main-image-container-fade"></div>
          <div id="thumbnail-container" class="thumbnail-container-horizontal"></div>
        </div>
      </section>

      <section class="product-intro">
        <h1 id="product-name" class="product-title-main">Chargement...</h1>
        <p id="product-excerpt" class="product-excerpt-main"></p>
      </section>

      <!-- Section du formulaire dynamique -->
      <div id="form-container">
        <div class="loading-form">Chargement du formulaire...</div>
      </div>

      <section class="product-full-description">
        <h2 class="section-title-small">Description Détaillée</h2>
        <p id="product-description" class="product-description-main"></p>
      </section>

      <section class="payment-methods">
        <h2 class="section-title-small">Moyens de paiement acceptés</h2>
        <div class="payment-icons">
          <img src="https://www.iptv-store.shop/logo/binance-logo.png" alt="Binance Pay" />
          <img src="https://www.iptv-store.shop/logo/iban-logo.png" alt="Virement bancaire IBAN" />
          <img src="https://www.iptv-store.shop/logo/paypal-logo.png" alt="PayPal" />
        </div>
      </section>

      <div class="share-buttons-container">
        <a id="share-facebook" class="share-btn facebook" href="#" target="_blank" aria-label="Partager sur Facebook"
          ><i class="fab fa-facebook-f"></i
        ></a>
        <a id="share-twitter" class="share-btn twitter" href="#" target="_blank" aria-label="Partager sur Twitter"
          ><i class="fab fa-twitter"></i
        ></a>
        <a id="share-whatsapp" class="share-btn whatsapp" href="#" target="_blank" aria-label="Partager sur WhatsApp"
          ><i class="fab fa-whatsapp"></i
        ></a>
        <a id="share-telegram" class="share-btn telegram" href="#" target="_blank" aria-label="Partager sur Telegram"
          ><i class="fab fa-telegram-plane"></i
        ></a>
        <button id="copy-link" class="share-btn copy-link" aria-label="Copier le lien">
          <i class="fas fa-copy"></i>
        </button>
      </div>
    </main>
    
    <div id="waitingMessage" class="waiting-message" style="display: none">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
    <div id="customAlert" class="custom-alert" style="display: none">
      <div class="alert-content">
        <span class="close-btn" onclick="closeAlert()">&times;</span>
        <p id="alertMessage"></p>
        <button class="ok-btn" onclick="closeAlert()">OK</button>
      </div>
    </div>
    <div id="lightbox" class="lightbox-overlay">
      <span class="lightbox-close">&times;</span><img id="lightbox-image" class="lightbox-image" src="" />
    </div>

    <div id="footer-placeholder"></div>
    
    <script src="products-db.js"></script>
    <script src="script.js"></script>
    
    <script>
      // Variables globales pour cette page
      let currentProduct = null;
      let useDZD = false;

      // Fonction pour récupérer l'ID du produit depuis l'URL
      function getProductIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
      }

      // Fonction pour trouver le produit dans la base de données
      function findProductById(productId) {
        if (typeof products !== 'undefined') {
          return products.find(p => p.id === productId);
        }
        return null;
      }

      // Détection du pays
      async function detectUserCountry() {
        try {
          const response = await fetch('https://api.ipdata.co/?api-key=916c6b6e4d160441313fb81c071aa9aadd988baa6e8e4361cfa6ad38');
          const data = await response.json();
          useDZD = (data.country_code === 'DZ');
          console.log('Pays détecté:', data.country_code, 'useDZD:', useDZD);
          return useDZD;
        } catch (error) {
          console.error('Erreur détection pays:', error);
          useDZD = false;
          return false;
        }
      }

      // Fonction pour créer le formulaire virtuel
      function createVirtualForm(product) {
        const price = useDZD ? (product.price_dzd || product.price * 160) : product.price;
        const currency = useDZD ? ' DZD' : ' €';
        const priceFormatted = useDZD ? price.toFixed(0) : price.toFixed(2);
        
        return `
          <section class="product-form-section virtual-form">
            <form id="orderForm" class="order-form-card">
              <h3 class="form-title">Passez votre commande</h3>
              <p class="product-price-main" id="popupPrice">${priceFormatted}${currency}</p>

              <div class="form-group">
                <i class="fas fa-server icon"></i>
                <select id="serverType" onchange="toggleServerFields(); updateTotalPrice()">
                  ${(product.serverTypes || []).map(type => 
                    `<option value="${type}">${type}</option>`
                  ).join('')}
                </select>
              </div>
              <div id="serverFields" class="server-fields"></div>
              
              <div class="form-group">
                <i class="fas fa-cubes icon"></i>
                <input type="number" id="quantity" value="1" min="1" onchange="updateTotalPrice()" placeholder="Quantité" />
              </div>
              
              <div class="form-group">
                <i class="fas fa-user icon"></i>
                <input type="text" id="name" placeholder="Votre Nom *" />
              </div>
              <p class="error-message" id="nameError"></p>

              <div class="form-group">
                <div class="whatsapp-input-group">
                  <select id="selectedCountryCode" class="country-code-select-standalone"></select>
                  <input type="tel" id="phone" placeholder="Numéro WhatsApp" />
                </div>
              </div>
              <p class="error-message" id="phoneError"></p>

              <div class="form-group">
                <i class="fas fa-envelope icon"></i>
                <input type="email" id="email" placeholder="Adresse Email (Optionnel)" />
              </div>
              <p class="error-message" id="emailError"></p>

              <div class="button-group">
                <button type="button" class="btn btn-whatsapp" onclick="sendVirtualOrder('whatsapp')">
                  <i class="fab fa-whatsapp"></i> Commander via WhatsApp
                </button>
                <button type="button" class="btn btn-email" onclick="sendVirtualOrder('email')">
                  <i class="fas fa-envelope"></i> Commander par Email
                </button>
              </div>
            </form>
          </section>
        `;
      }

      // Fonction pour envoyer la commande virtuelle
      function sendVirtualOrder(method) {
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();

        // Commande rapide WhatsApp sans formulaire
        if (method === 'whatsapp' && !name && !phone) {
          const productUrl = window.location.href;
          const price = useDZD ? (currentProduct.price_dzd || currentProduct.price * 160) : currentProduct.price;
          const currency = useDZD ? 'DZD' : 'EUR';
          const priceFormatted = useDZD ? price.toFixed(0) : price.toFixed(2);
          
          const simpleMessage = `Bonjour, je souhaite commander ce produit :\n\n` +
                                `*Produit :* ${currentProduct.name}\n` +
                                `*Prix :* ${priceFormatted} ${currency}\n` +
                                `*Lien :* ${productUrl}`;
          
          const whatsappUrl = `https://api.whatsapp.com/send?phone=213770759886&text=${encodeURIComponent(simpleMessage)}`;
          window.open(whatsappUrl, '_blank');
          displayAlert('Redirection vers WhatsApp...');
          return; 
        }

        // Validation du formulaire
        clearErrors();
        let valid = true;
        const email = document.getElementById("email").value.trim();
        const phoneRegex = /^\d{7,15}$/;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!name) {
          valid = false;
          document.getElementById("nameError").innerText = "Veuillez entrer votre nom.";
        }

        if (method === 'email' && !phone) {
          valid = false;
          document.getElementById("phoneError").innerText = "Veuillez entrer un numéro de téléphone.";
        } else if (phone && !phoneRegex.test(phone.replace(/[\s-()]/g, ''))) {
          valid = false;
          document.getElementById("phoneError").innerText = "Le format du numéro est invalide.";
        }

        if (email && !emailRegex.test(email)) {
          valid = false;
          document.getElementById("emailError").innerText = "Veuillez entrer une adresse email valide.";
        }
        
        if (!valid) {
          const firstError = document.querySelector('.error-message:not(:empty)');
          if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return;
        }

        // Préparation du message
        displayWaitingMessage();
        const quantity = parseInt(document.getElementById("quantity").value);
        const price = useDZD ? (currentProduct.price_dzd || currentProduct.price * 160) : currentProduct.price;
        const totalPrice = price * quantity;
        const orderNumber = generateOrderNumber();
        const fullPhoneNumber = phone ? `${document.getElementById("selectedCountryCode").value}${phone}` : 'N/A';
        const serverType = document.getElementById("serverType").value;
        const finalEmail = email || 'N/A';
        const currency = useDZD ? 'DZD' : 'EUR';
        
        const detailedMessage = `*Nouvelle commande!*\n*Numéro: ${orderNumber}\n*Produit: ${currentProduct.name}\n*Serveur: ${serverType}\n*Nom: ${name}\n*WhatsApp: ${fullPhoneNumber}\n*Email: ${finalEmail}\n*Prix unitaire: ${price.toFixed(useDZD ? 0 : 2)} ${currency}\n*Quantité: ${quantity}\n*Total: ${totalPrice.toFixed(useDZD ? 0 : 2)} ${currency}`;

        if (method === 'whatsapp') {
          window.open(`https://api.whatsapp.com/send?phone=213770759886&text=${encodeURIComponent(detailedMessage)}`, '_blank');
          hideWaitingMessage();
          displayAlert(`Redirection vers WhatsApp...`);
          document.getElementById('orderForm').reset();
        } else if (method === 'email') {
          const templateParams = { 
            orderNumber, 
            product: currentProduct.name, 
            serverType: serverType, 
            name: name, 
            phone: fullPhoneNumber, 
            email: finalEmail, 
            productPrice: price.toFixed(useDZD ? 0 : 2), 
            quantity: quantity, 
            totalPrice: totalPrice.toFixed(useDZD ? 0 : 2), 
            productDescription: currentProduct.description,
            currency: currency
          };
          emailjs.send("service_geh79gu", "template_vny80g3", templateParams)
            .then(() => {
              hideWaitingMessage();
              displayAlert(`Commande envoyée!<br>Numéro: ${orderNumber}`);
              document.getElementById('orderForm').reset();
            }, () => {
              hideWaitingMessage();
              displayAlert("Échec de l'envoi. Veuillez réessayer.");
            });
        }
      }

      // Fonctions utilitaires
      function clearErrors() {
        document.querySelectorAll(".error-message").forEach(el => el.innerText = '');
      }

      function displayWaitingMessage() {
        const el = document.getElementById('waitingMessage');
        if(el) el.style.display = 'flex';
      }

      function hideWaitingMessage() {
        const el = document.getElementById('waitingMessage');
        if(el) el.style.display = 'none';
      }

      function displayAlert(message) {
        const alertMessage = document.getElementById('alertMessage');
        const customAlert = document.getElementById('customAlert');
        if (alertMessage) alertMessage.innerHTML = message;
        if (customAlert) customAlert.style.display = 'flex';
      }

      function closeAlert() {
        const customAlert = document.getElementById('customAlert');
        if (customAlert) customAlert.style.display = 'none';
      }

      function generateOrderNumber() {
        return `ORD-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
      }

      function updateTotalPrice() {
        const quantity = parseInt(document.getElementById("quantity")?.value || 1);
        const priceDisplay = document.getElementById('popupPrice');
        if (!priceDisplay || !currentProduct) return;
        
        const price = useDZD ? (currentProduct.price_dzd || currentProduct.price * 160) : currentProduct.price;
        let total = price * (quantity || 1);
        
        if (quantity > 20) total *= 0.9;
        else if (quantity > 10) total *= 0.95;
        
        const currency = useDZD ? ' DZD' : ' €';
        const decimals = useDZD ? 0 : 2;
        priceDisplay.innerText = total.toFixed(decimals) + currency;
      }

      function toggleServerFields() {
        const serverType = document.getElementById("serverType")?.value;
        const serverFields = document.getElementById('serverFields');
        if (!serverFields) return;

        serverFields.innerHTML = '';

        if (serverType === "mag") {
          serverFields.innerHTML = `
            <div class="form-group">
              <i class="fas fa-envelope icon"></i>
              <input type="text" id="macAddress" placeholder="Adresse MAC (ex: 00:1A:2B:3C:4D:5E)" maxlength="17" />
            </div>
          `;
          
          const macAddressInput = document.getElementById('macAddress');
          if (macAddressInput) {
            macAddressInput.addEventListener('input', (e) => {
              let value = e.target.value.replace(/[^0-9a-fA-F]/g, '');
              if (e.target.value.length > 0) {
                let formattedValue = (value.match(/.{1,2}/g) || []).join(':');
                e.target.value = formattedValue;
              }
            });
          }
        }
      }

      // Fonction pour initialiser la page produit
      async function initializeProductPage() {
        const productId = getProductIdFromURL();
        currentProduct = findProductById(productId);
        
        if (!currentProduct) {
          window.location.href = '404.html';
          return;
        }

        // Détecter le pays
        await detectUserCountry();

        // Mettre à jour les informations du produit
        document.getElementById('product-name').textContent = currentProduct.name;
        
        // Description et extrait
        const fullDescription = currentProduct.description || '';
        document.getElementById('product-description').textContent = fullDescription;
        
        const excerptElement = document.getElementById('product-excerpt');
        if (excerptElement) {
          let firstLine = fullDescription.split('\n')[0];
          let excerpt = firstLine.substring(0, 120);
          if (fullDescription.length > excerpt.length) {
            excerpt += '...';
          }
          excerptElement.textContent = excerpt;
        }

        // Initialiser la galerie
        setupCombinedGallery(currentProduct);

        // Initialiser le lightbox
        setupLightbox(currentProduct);

        // Initialiser les boutons de partage
        setupShareButtons(currentProduct);

        // Charger le bon formulaire
        const formContainer = document.getElementById('form-container');
        
        if (currentProduct.product_type === 'physical') {
          // Pour les produits physiques, on va créer un formulaire simple
          const price = useDZD ? (currentProduct.price_dzd || currentProduct.price * 160) : currentProduct.price;
          const currency = useDZD ? ' DZD' : ' €';
          const priceFormatted = useDZD ? price.toFixed(0) : price.toFixed(2);
          
          formContainer.innerHTML = `
            <div class="delivery-form">
              <h3>Produit Physique - Livraison Algérie</h3>
              <p class="price">${priceFormatted}${currency}</p>
              <p>Pour commander ce produit physique, contactez-nous directement sur WhatsApp :</p>
              <button class="btn btn-whatsapp" onclick="contactForPhysicalProduct()" style="margin-top: 20px;">
                <i class="fab fa-whatsapp"></i> Commander sur WhatsApp
              </button>
            </div>
          `;
        } else {
          // Produit virtuel
          formContainer.innerHTML = createVirtualForm(currentProduct);
          
          // Initialiser les codes pays
          if (typeof countryCodes !== 'undefined') {
            populateCountryCodes('selectedCountryCode');
          }
          
          // Initialiser les champs serveur
          toggleServerFields();
        }

        // Mettre à jour le schema SEO
        updateProductSchema(currentProduct);
      }

      function contactForPhysicalProduct() {
        const price = useDZD ? (currentProduct.price_dzd || currentProduct.price * 160) : currentProduct.price;
        const currency = useDZD ? 'DZD' : 'EUR';
        const priceFormatted = useDZD ? price.toFixed(0) : price.toFixed(2);
        
        const message = `Bonjour, je souhaite commander le produit physique :\n\n` +
                       `*Produit :* ${currentProduct.name}\n` +
                       `*Prix :* ${priceFormatted} ${currency}\n` +
                       `*Lien :* ${window.location.href}`;
        
        const whatsappUrl = `https://api.whatsapp.com/send?phone=213770759886&text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
      }

      // Fonction pour mettre à jour le schema SEO
      function updateProductSchema(product) {
        const price = useDZD ? (product.price_dzd || product.price * 160) : product.price;
        const currency = useDZD ? "DZD" : "EUR";
        
        const schema = {
          "@context": "https://schema.org/",
          "@type": "Product",
          "name": product.name,
          "image": product.images[0],
          "description": product.description,
          "sku": product.id,
          "brand": {
            "@type": "Brand",
            "name": "IPTV Store"
          },
          "offers": {
            "@type": "Offer",
            "url": window.location.href,
            "priceCurrency": currency,
            "price": useDZD ? (product.price_dzd || product.price * 160).toFixed(0) : product.price.toFixed(2),
            "availability": "https://schema.org/InStock",
            "itemCondition": "https://schema.org/NewCondition"
          }
        };
        
        const schemaScript = document.getElementById('product-schema');
        if (schemaScript) {
          schemaScript.textContent = JSON.stringify(schema);
        }
      }

      // Initialiser EmailJS
      emailjs.init("WNOIpj1FX2dDPSQMS");

      // Charger les composants header/footer
      function loadComponent(url, elementId) {
        fetch(url)
          .then(response => response.text())
          .then(data => {
            const element = document.getElementById(elementId);
            if(element) element.innerHTML = data;
          })
          .catch(error => console.error(`Error loading component ${url}:`, error));
      }

      // Initialiser la page au chargement
      document.addEventListener('DOMContentLoaded', function() {
        loadComponent('header.html', 'header-placeholder');
        loadComponent('footer.html', 'footer-placeholder');
        initializeProductPage();
      });
    </script>
  </body>
</html>
