<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Détails du Produit - IPTV Store</title>

    <meta
      name="description"
      content="Découvrez nos abonnements IPTV premium. Service de haute qualité, stable et riche en contenu."
    />

    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://raw.githack.com/OraHighTech/OrderTvCode/main/indicatif.js"></script>
    <script src="https://raw.githack.com/OraHighTech/e-commerce/main/wilayasCommunes.js"></script>
    <script type="application/ld+json" id="product-schema"></script>
  </head>
  <body>
    <div id="header-placeholder"></div>

    <main class="product-page-container-new">
      <section class="product-gallery-section">
        <div class="image-gallery-horizontal">
          <div class="main-image-container-fade"></div>
          <div id="thumbnail-container" class="thumbnail-container-horizontal"></div>
        </div>
      </section>

      <section class="product-intro">
        <h1 id="product-name" class="product-title-main">Chargement...</h1>
        <p id="product-excerpt" class="product-excerpt-main"></p>
      </section>

      <!-- Section du formulaire dynamique -->
      <div id="form-container">
        <!-- Le formulaire sera chargé dynamiquement ici -->
      </div>

      <section class="product-full-description">
        <h2 class="section-title-small">Description Détaillée</h2>
        <p id="product-description" class="product-description-main"></p>
      </section>

      <section class="payment-methods">
        <h2 class="section-title-small">Moyens de paiement acceptés</h2>
        <div class="payment-icons">
          <img src="https://www.iptv-store.shop/logo/binance-logo.png" alt="Binance Pay" />
          <img src="https://www.iptv-store.shop/logo/iban-logo.png" alt="Virement bancaire IBAN" />
          <img src="https://www.iptv-store.shop/logo/paypal-logo.png" alt="PayPal" />
        </div>
      </section>

      <div class="share-buttons-container">
        <a id="share-facebook" class="share-btn facebook" href="#" target="_blank" aria-label="Partager sur Facebook"
          ><i class="fab fa-facebook-f"></i
        ></a>
        <a id="share-twitter" class="share-btn twitter" href="#" target="_blank" aria-label="Partager sur Twitter"
          ><i class="fab fa-twitter"></i
        ></a>
        <a id="share-whatsapp" class="share-btn whatsapp" href="#" target="_blank" aria-label="Partager sur WhatsApp"
          ><i class="fab fa-whatsapp"></i
        ></a>
        <a id="share-telegram" class="share-btn telegram" href="#" target="_blank" aria-label="Partager sur Telegram"
          ><i class="fab fa-telegram-plane"></i
        ></a>
        <button id="copy-link" class="share-btn copy-link" aria-label="Copier le lien">
          <i class="fas fa-copy"></i>
        </button>
      </div>
    </main>
    
    <div id="waitingMessage" class="waiting-message" style="display: none">
      <i class="fas fa-spinner fa-spin"></i>
    </div>
    <div id="customAlert" class="custom-alert" style="display: none">
      <div class="alert-content">
        <span class="close-btn" onclick="closeAlert()">&times;</span>
        <p id="alertMessage"></p>
        <button class="ok-btn" onclick="closeAlert()">OK</button>
      </div>
    </div>
    <div id="lightbox" class="lightbox-overlay">
      <span class="lightbox-close">&times;</span><img id="lightbox-image" class="lightbox-image" src="" />
    </div>

    <div id="footer-placeholder"></div>
    
    <script src="products-db.js"></script>
    <script src="formulaire-livraison.js"></script>
    <script src="script.js"></script>
    
    <script>
      // Fonction pour récupérer l'ID du produit depuis l'URL
      function getProductIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
      }

      // Fonction pour trouver le produit dans la base de données
      function findProductById(productId) {
        if (typeof products !== 'undefined') {
          return products.find(p => p.id === productId);
        }
        return null;
      }

      // Fonction pour charger le formulaire de livraison
      async function loadDeliveryForm() {
        try {
          const response = await fetch('formulaire-livraison.html');
          const html = await response.text();
          return html;
        } catch (error) {
          console.error('Erreur chargement formulaire livraison:', error);
          return '<div class="error-message">Formulaire de livraison non disponible</div>';
        }
      }

      // Fonction pour créer le formulaire virtuel
      function createVirtualForm() {
        return `
          <section class="product-form-section virtual-form">
            <form id="orderForm" class="order-form-card">
              <h3 class="form-title">Passez votre commande</h3>
              <p class="product-price-main" id="popupPrice"></p>

              <div class="form-group">
                <i class="fas fa-server icon"></i>
                <select id="serverType" onchange="toggleServerFields(); updateTotalPrice()"></select>
              </div>
              <div id="serverFields" class="server-fields"></div>
              <p class="error-message"></p>
              
              <div class="form-group">
                <i class="fas fa-cubes icon"></i>
                <input type="number" id="quantity" value="1" min="1" onchange="updateTotalPrice()" placeholder="Quantité" />
              </div>
              <p class="error-message"></p>
              
              <div class="form-group">
                <i class="fas fa-user icon"></i>
                <input type="text" id="name" placeholder="Votre Nom *" />
              </div>
              <p class="error-message" id="nameError"></p>

              <div class="form-group">
                <div class="whatsapp-input-group">
                  <select id="selectedCountryCode" class="country-code-select-standalone"></select>
                  <input type="tel" id="phone" placeholder="Numéro WhatsApp" />
                </div>
              </div>
              <p class="error-message" id="phoneError"></p>

              <div class="form-group">
                <i class="fas fa-envelope icon"></i>
                <input type="email" id="email" placeholder="Adresse Email (Optionnel)" />
              </div>
              <p class="error-message" id="emailError"></p>

              <div class="button-group">
                <button type="button" class="btn btn-whatsapp" onclick="sendOrder('whatsapp')">
                  <i class="fab fa-whatsapp"></i> Commander via WhatsApp
                </button>
                <button type="button" class="btn btn-email" onclick="sendOrder('email')">
                  <i class="fas fa-envelope"></i> Commander par Email
                </button>
              </div>
            </form>
          </section>
        `;
      }

      // Fonction pour initialiser la page produit
      async function initializeProductPage() {
        const productId = getProductIdFromURL();
        const product = findProductById(productId);
        
        if (!product) {
          window.location.href = '404.html';
          return;
        }

        // Mettre à jour les informations du produit
        document.getElementById('product-name').textContent = product.name;
        
        // Description et extrait
        const fullDescription = product.description || '';
        document.getElementById('product-description').textContent = fullDescription;
        
        const excerptElement = document.getElementById('product-excerpt');
        if (excerptElement) {
          let firstLine = fullDescription.split('\n')[0];
          let excerpt = firstLine.substring(0, 120);
          if (fullDescription.length > excerpt.length) {
            excerpt += '...';
          }
          excerptElement.textContent = excerpt;
        }

        // Initialiser la galerie
        if (typeof setupCombinedGallery === 'function') {
          setupCombinedGallery(product);
        }

        // Initialiser le lightbox
        if (typeof setupLightbox === 'function') {
          setupLightbox(product);
        }

        // Initialiser les boutons de partage
        if (typeof setupShareButtons === 'function') {
          setupShareButtons(product);
        }

        // Charger le bon formulaire selon le type de produit
        const formContainer = document.getElementById('form-container');
        
        if (product.product_type === 'physical') {
          // Charger le formulaire de livraison
          const deliveryFormHtml = await loadDeliveryForm();
          formContainer.innerHTML = deliveryFormHtml;
          
          // Initialiser le formulaire de livraison
          if (typeof initializeDeliveryForm === 'function') {
            initializeDeliveryForm(product);
          }
        } else {
          // Utiliser le formulaire virtuel
          formContainer.innerHTML = createVirtualForm();
          
          // Initialiser le formulaire virtuel
          if (typeof initializeProductForm === 'function') {
            initializeProductForm(product);
          }
          
          // Initialiser les codes pays si disponible
          if (typeof countryCodes !== 'undefined' && typeof populateCountryCodes === 'function') {
            populateCountryCodes('selectedCountryCode');
          }
        }

        // Mettre à jour le schema SEO
        updateProductSchema(product);
      }

      // Fonction pour mettre à jour le schema SEO
      function updateProductSchema(product) {
        const schema = {
          "@context": "https://schema.org/",
          "@type": "Product",
          "name": product.name,
          "image": product.images[0],
          "description": product.description,
          "sku": product.id,
          "brand": {
            "@type": "Brand",
            "name": "IPTV Store"
          },
          "offers": {
            "@type": "Offer",
            "url": window.location.href,
            "priceCurrency": "EUR",
            "price": product.price.toFixed(2),
            "availability": "https://schema.org/InStock",
            "itemCondition": "https://schema.org/NewCondition"
          }
        };
        
        const schemaScript = document.getElementById('product-schema');
        if (schemaScript) {
          schemaScript.textContent = JSON.stringify(schema);
        }
      }

      // Initialiser la page au chargement
      document.addEventListener('DOMContentLoaded', function() {
        initializeProductPage();
        
        // Charger les composants header/footer
        if (typeof loadComponent === 'function') {
          loadComponent('header.html', 'header-placeholder');
          loadComponent('footer.html', 'footer-placeholder');
        } else {
          // Fallback si loadComponent n'est pas disponible
          fetch('header.html')
            .then(response => response.text())
            .then(html => {
              document.getElementById('header-placeholder').innerHTML = html;
            });
          
          fetch('footer.html')
            .then(response => response.text())
            .then(html => {
              document.getElementById('footer-placeholder').innerHTML = html;
            });
        }

        // Initialiser EmailJS si disponible
        if (typeof emailjs !== 'undefined') {
          emailjs.init("WNOIpj1FX2dDPSQMS");
        }
      });

      // Fonction utilitaire pour charger les composants (fallback)
      function loadComponent(url, elementId) {
        fetch(url)
          .then(response => {
            if (!response.ok) throw new Error('File not found');
            return response.text();
          })
          .then(data => {
            const element = document.getElementById(elementId);
            if (element) element.innerHTML = data;
          })
          .catch(error => console.error(`Error loading component ${url}:`, error));
      }
    </script>
  </body>
</html>

